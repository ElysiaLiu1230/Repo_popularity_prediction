---
- name: Deploy best model to production
  hosts: prod
  become: false
  tasks:
    - name: Ensure target directory exists
      file:
        path: /home/ubuntu/project/models
        state: directory
        mode: '0755'

    - name: Copy best model to production
      copy:
        src: ../models/best_model.pkl
        dest: /home/ubuntu/project/models/best_model.pkl
        mode: '0644'
        

    - name: Restart Flask app 
      shell: |
        pkill -f "python3 app.py" || true
        sleep 2
        nohup python3 /home/ubuntu/project/app/app.py > /home/ubuntu/project/app/app.log 2>&1 &
      args:
        executable: /bin/bash
    # - name: Restart Flask app (non-blocking)
    #   shell: |
    #     pgrep -f "python3 app.py" && pkill -f "python3 app.py"
    #     nohup python3 /home/ubuntu/project/app/app.py > /home/ubuntu/project/app/app.log 2>&1 &
    #   args:
    #     executable: /bin/bash
    #   ignore_errors: true